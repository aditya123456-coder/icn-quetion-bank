<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <title>Question Bank</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #ff6f61;
      --secondary: #2c3e50;
      --background: #f0f0f0;
      --card-bg: rgba(255, 255, 255, 0.25);
      --glass: rgba(255, 255, 255, 0.15);
      --blur: 10px;
    }
    * { box-sizing: border-box; transition: all 0.3s ease; }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #66a6ff;
      backdrop-filter: blur(var(--blur));
      overflow-x: hidden;
    }
    header {
      background: var(--glass);
      backdrop-filter: blur(var(--blur));
      color: var(--secondary);
      padding: 1rem 2rem;
      border-bottom: 1px solid #ccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { margin: 0; font-size: 2rem; color: var(--primary); }
    .fab {
      position: fixed;
      right: 30px; bottom: 30px;
      width: 60px; height: 60px;
      background: var(--primary);
      border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      box-shadow: 0 8px 15px rgba(0,0,0,0.2);
      cursor: pointer; color: white; font-size: 1.5rem; z-index: 999;
    }
    .container { padding: 2rem; }
    .card {
      background: var(--card-bg);
      backdrop-filter: blur(var(--blur));
      padding: 1.5rem; border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      color: var(--secondary); margin: 10px 0;
      animation: fadeIn 0.5s ease forwards;
    }
    @keyframes fadeIn {
      from { opacity:0; transform: translateY(10px) }
      to   { opacity:1; transform: translateY(0) }
    }
    .card h3 { margin-top:0; display:flex; align-items:center; gap:10px }
    .toggle { cursor:pointer; margin-right:8px }
    .children { margin-left:30px }
    .link a { color: var(--secondary); text-decoration:none }
    .link a:hover { text-decoration:underline }
    #helpOverlay {
      display:none; position:fixed; top:0; left:0;
      width:100%; height:100%; background:rgba(0,0,0,0.5);
      z-index:1000;
    }
    /* ... (responsive CSS omitted for brevity; same as before) ... */
  </style>
</head>
<body>
  <div id="helpOverlay">
    <div style="background:#fff; padding:20px; margin:50px auto; width:80%; max-width:600px; border-radius:10px;">
      <h2>üìö How to Use</h2>
      <p>1. Click <button style="padding:5px 10px">Import</button> to load your notes</p>
      <p>2. Download sample file: <button onclick="downloadSample()">Download Example.json</button></p>
      <p>3. Drag & drop JSON files anywhere to import</p>
      <button onclick="closeHelp()" style="margin-top:20px">Close Help</button>
    </div>
  </div>

  <header>
    <h1><i class="fa-solid fa-folder-open"></i> Question Bank
      <button onclick="showHelp()" style="font-size:0.8em; margin-left:10px; display:none">‚ùì Help</button>
    </h1>
    <div>
      <button style="background:chartreuse; border:none; padding:10px; border-radius:10px">
        <a href="pre.html" style="text-decoration:none; color:#000">Premium</a>
      </button>
      <button onclick="toggleDarkMode()" style="display:none">üåó Toggle Theme</button>
      <button onclick="exportData()" style="display:none">Export</button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
      <button onclick="importFile.click()" style="display:none">Import</button>
    </div>
  </header>

  <main class="container" id="questionContainer"></main>

  <div class="fab" onclick="addParentFolder()" style="display:none">
    <i class="fa fa-plus"></i>
  </div>

  <script>
    let appData = [];

    // === RECURSIVE MERGE ===
    function mergeData(baseArr, localArr) {
      const localById = localArr.reduce((m, it) => { m[it.id]=it; return m; }, {});
      const result = baseArr.map(base => {
        const local = localById[base.id];
        if (!local) {
          // no local override: but if folder, still need to merge children recursively
          if (base.type==='folder') {
            return {
              ...base,
              children: mergeData(base.children||[], []),
            };
          }
          return base;
        }
        // local exists: merge shallow, but handle children specially
        if (base.type==='folder') {
          return {
            ...base,
            ...local,
            children: mergeData(base.children||[], local.children||[]),
          };
        } else {
          return { ...base, ...local };
        }
      });

      // append purely-local extras
      const baseIds = new Set(baseArr.map(it=>it.id));
      const extras = localArr.filter(it=>!baseIds.has(it.id));
      // but for extras that are folders, we must preserve their children too
      return result.concat(extras);
    }

    // === INIT ===
    (async function init() {
      try {
        const resp = await fetch('data.json');
        if (!resp.ok) throw new Error('data.json not found');
        const base = await resp.json();
        if (!validateData(base)) throw new Error('Invalid data.json');

        const raw = localStorage.getItem('questionBank');
        const local = raw ? JSON.parse(raw) : [];

        appData = mergeData(base, local);
        localStorage.setItem('questionBank', JSON.stringify(appData));
        render();
      } catch (e) {
        console.error('Init error', e);
        const raw = localStorage.getItem('questionBank');
        appData = raw ? JSON.parse(raw) : [];
        render();
      }
    })();

    function validateData(data) {
      return Array.isArray(data) && data.every(item => {
        if (!item.id||!item.name) return false;
        if (item.type==='folder')
          return Array.isArray(item.children) && typeof item.expanded==='boolean';
        if (item.type==='link')
          return typeof item.url==='string';
        return false;
      });
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2,9);
    }

    function saveData() {
      localStorage.setItem('questionBank', JSON.stringify(appData));
      render();
    }

    function render() {
      const c = document.getElementById('questionContainer');
      c.innerHTML = '';
      appData.forEach(folder => renderFolder(folder, c));
    }

    function renderFolder(folder, container) {
      const el = document.createElement('div');
      el.className = 'card folder';
      el.innerHTML = `
        <h3>
          <span class="toggle" onclick="toggleFolder('${folder.id}')">
            ${folder.expanded ? '‚ñº' : '‚ñ∂'}
          </span>
          <span contenteditable="false" onblur="updateName('${folder.id}', this.textContent)">
            ${folder.name}
          </span>
        </h3>
        <div class="children" ${!folder.expanded ? 'style="display:none"' : ''}></div>
      `;
      container.appendChild(el);
      const childContainer = el.querySelector('.children');
      if (folder.expanded) {
        folder.children.forEach(ch =>
          ch.type==='folder'
            ? renderFolder(ch, childContainer)
            : renderLink(ch, childContainer)
        );
      }
    }

    function renderLink(link, container) {
      const el = document.createElement('div');
      el.className = 'card link';
      el.innerHTML = `
        <h3>
          <span contenteditable="false" onblur="updateName('${link.id}', this.textContent)">
            ${link.name}
          </span>
          <a href="${link.url}" target="_blank"><i class="fa fa-external-link-alt"></i></a>
        </h3>
      `;
      container.appendChild(el);
    }

    function findItem(id, arr=appData) {
      for (const it of arr) {
        if (it.id===id) return it;
        if (it.type==='folder') {
          const found = findItem(id, it.children);
          if (found) return found;
        }
      }
      return null;
    }

    function toggleFolder(id) {
      const f = findItem(id);
      if (f) { f.expanded = !f.expanded; saveData(); }
    }

    function updateName(id, txt) {
      const it = findItem(id);
      if (it) { it.name = txt; saveData(); }
    }

    function addParentFolder() {
      appData.push({
        id: generateId(),
        name: 'New Parent Folder',
        type: 'folder',
        children: [],
        expanded: false
      });
      saveData();
    }

    function addFolder(parentId) {
      const p = findItem(parentId);
      if (!p || p.type!=='folder') return;
      p.children.push({
        id: generateId(),
        name: 'New Folder',
        type: 'folder',
        children: [],
        expanded: false
      });
      saveData();
    }

    function addLink(parentId) {
      const p = findItem(parentId);
      if (!p || p.type!=='folder') return;
      const url = prompt('Enter URL:');
      if (!url) return;
      const name = prompt('Enter name:')||'New Link';
      p.children.push({ id: generateId(), name, type:'link', url });
      saveData();
    }

    function deleteItem(id) {
      if (!confirm('Delete?')) return;
      (function rm(arr) {
        const idx = arr.findIndex(x=>x.id===id);
        if (idx!==-1) return arr.splice(idx,1);
        for (const x of arr) if (x.type==='folder') rm(x.children);
      })(appData);
      saveData();
    }

    function exportData() {
      const blob = new Blob([JSON.stringify(appData,null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'questionBank.json';
      a.click();
    }

    function importData(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const d = JSON.parse(e.target.result);
          if (!validateData(d)) throw new Error('Bad structure');
          localStorage.setItem('questionBank', JSON.stringify(d));
          location.reload();
        } catch (err) {
          alert('Import failed: '+err.message);
        }
      };
      reader.readAsText(file);
    }

    function downloadSample() {
      const sample = [{
        id:'sample-folder', name:'Sample Chapter',
        type:'folder', expanded:true,
        children:[{ id:'sample-link', name:'Example Link', type:'link', url:'https://example.com' }]
      }];
      const blob = new Blob([JSON.stringify(sample,null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'SampleNotes.json';
      a.click();
    }

    function showHelp() { document.getElementById('helpOverlay').style.display='block'; }
    function closeHelp(){ document.getElementById('helpOverlay').style.display='none'; }

    document.body.addEventListener('dragover', e=>e.preventDefault());
    document.body.addEventListener('drop', e=>{
      e.preventDefault();
      const f = e.dataTransfer.files[0];
      if (f) importData({ target:{ files:[f] } });
    });
  </script>
</body>
</html>
